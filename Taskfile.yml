version: '3'

tasks:
  dev:setup:
    desc: "Main setup hook (Runs on postCreate)"
    cmds:
      - task: dev:shell
      - task: dev:git

  dev:start:
    desc: "Startup hook (Runs on postStart)"
    cmd: git submodule update --init --recursive

  dev:shell:
    desc: "Apply clean shell configuration"
    cmds:
      - cp .devcontainer/.zshrc ~/.zshrc
      - direnv allow .

  dev:git:
    desc: "Rewrite Git URLs to use Token (Codespaces Only)"
    status:
      - '[ "$CODESPACES" != "true" ]'
    vars:
      AuthURL: "https://x-access-token:{{.GITHUB_TOKEN}}@github.com/"
    cmds:
      - for: 
          - "ssh://git@github.com/"
          - "git@github.com/"
          - "git@github.com:"
        cmd: git config --global --add url.{{.AuthURL}}.insteadOf {{.ITEM}}

  # Build tasks
  build:release:
    desc: "Build the project in release mode"
    cmd: cargo build --release

  # CI tasks
  ci:check:
    desc: "Run cargo check"
    cmd: cargo check --all-features

  ci:clippy:
    desc: "Run cargo clippy"
    cmd: cargo clippy --all-features -- -D warnings

  ci:fmt:
    desc: "Check code formatting"
    cmd: cargo fmt -- --check

  ci:test:
    desc: "Run tests"
    cmd: cargo nextest run --all-features

  ci:build:
    desc: "Build release binary for target"
    cmd: cargo build --release --target {{.TARGET}}

  # Test tasks
  test:watch:
    desc: "Watch and run tests on changes"
    cmd: cargo watch -x test

  # Run tasks  
  run:watch:
    desc: "Watch and run the server on changes"
    cmd: cargo watch -x run

  # Clean tasks
  clean:docker:
    desc: "Clean Docker build cache"
    cmd: docker builder prune -f

  # Docker tasks
  docker:build-multiarch:
    desc: "Build multi-arch images locally"
    cmd: |
      docker buildx build . \
        --platform linux/amd64,linux/arm64 \
        --tag k8swalski:latest

  # sccache tasks
  sccache:stats:
    desc: "Show sccache statistics"
    cmd: sccache --show-stats

  sccache:clear:
    desc: "Clear sccache cache"
    cmds:
      - sccache --stop-server || true
      - rm -rf ~/.cache/sccache
